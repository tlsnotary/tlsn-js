import { TlsProof as _TlsProof } from '../../src/lib';
import { assert } from '../utils';
import * as Comlink from 'comlink';

const { init, TlsProof }: any = Comlink.wrap(
  // @ts-ignore
  new Worker(new URL('../worker.ts', import.meta.url)),
);

(async function verify_simple() {
  try {
    await init({ loggingLevel: 'Debug' });

    console.time('verify');
    const proofHex = `ec5957996676ebb7a9fae815b95fc1810f51da828330451a98ac42d0fba400a04fdceca500ec864f455f80059eb489f39479fc6627a07c6b878fa12a4d0b81a18800000000000000d50300000000000083d0b96600000000000000004100000000000000048b68632f53328caddef6fd3bd7fb941e86817baa8c253b208c244842ecabef403f0ecfff9b8677be3126b746b74e87fcfd07c7dcde3630c184ddf2b6f8a751b4cfd0297a1196dab752fe9c8a178292c689e53b8c1d5705c117451402d1f7d90901000000007ea696ce46ee2a8d47d740d0bed704382a09b947cbd195467516bcc98823c33d2fb1f3a987a2cf7f26f675a14da6632c08797a1f62cecc68037dbcc7e442154c00000000090000000000000073776170692e646576f55ad8214e395cff68b4473e01edd56f7ae8fb13a82bb7a14dd15209ea92cc820200000000000000e504000000000000308204e1308203c9a0030201020212040e6bddc9c867581bd1fe861e51effc6741300d06092a864886f70d01010b05003033310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310c300a06035504031303523130301e170d3234303732353138313030325a170d3234313032333138313030315a3014311230100603550403130973776170692e64657630820122300d06092a864886f70d01010105000382010f003082010a0282010100ab14ab8a1c5d57666595d89614a985463bcb64057e324b5f747da1fc3ad527b0c3582849971c07e8815bed09414e5e18bde5e353bf8d9df4662c858dc39614cd2c2f688c413ebe38738db4e812b9505149e777ff2f694a3318ffe04f62f7052c7442b73515f2058b9c6db5f94daea900eba8c1c8dd0db05f7467996f73cb7ffc7ce930e0f2e95d6c420dba923412065003ea8ba716a0232f2dfd16368f6274fb23663b7561b8f38d3b061c49e5b5d35bba2b03f428af683074b38b33d6fcde4a9722a800ad4d4fba2cdf22b0b1444dc744c322c597fee0edc698fdd3c7cfaaa8fa63c23529b6995863552636dbadb358281bdf16ab7c5236a4eeb9ae2352aee10203010001a382020c30820208300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030106082b06010505070302300c0603551d130101ff04023000301d0603551d0e041604145b2712a1f0716bc6a81589f49af7ba123c7bfdac301f0603551d23041830168014bbbcc347a5e4bca9c6c3a4720c108da235e1c8e8305706082b06010505070101044b3049302206082b060105050730018616687474703a2f2f7231302e6f2e6c656e63722e6f7267302306082b060105050730028617687474703a2f2f7231302e692e6c656e63722e6f72672f30140603551d11040d300b820973776170692e64657630130603551d20040c300a3008060667810c01020130820103060a2b06010401d6790204020481f40481f100ef0075003f174b4fd7224758941d651c84be0d12ed90377f1f856aebc1bf2885ecf8646e00000190eb4ce2b30000040300463044022002dc6df6010b672341044a043bd0f226a8e7d82a91ec625b538caecc86e7a128022011f0a85da14142642ead5e2a9d48fd44914940df2044942500097f313693a1e100760048b0e36bdaa647340fe56a02fa9d30eb1c5201cb56dd2c81d9bbbfab39d8847300000190eb4ce2aa00000403004730450220720519eda2def160c991ea840ccc032f42f7f1ff32a200d9a2699c62366b7fbb022100de0aa1bff38efdef5c4e4ee8ae42eb02831a95d8c5a5df32a94c01672efc70e7300d06092a864886f70d01010b050003820101001386e3aa6c1e17247420870f89615f903c5020df62fa842e24a950516e6c7c82002befe448326db8b1baecdd7484c41b5256fc64b0f727e96e57189e45dbb6b7d9b8fcb4600154b1620738781643129a763c4761bb5e8781a11157654fc3fafad14c654e5dc8c3b131e61023ea03b9285bc651ff209f31a8d617b42524644731233ed88a5722a4ed5406ff6c877c20ed55fce6eb377d3d4018dbba99ba680932772cf1bb07d7e8e48cb1b210d1780ce168738e4d78bcf1da5a619c07d645629b5b0a3d0dca55aef13f24dc592266cf39fb1cdccca25a93f270c56c581776ba87a52cc7291496cd5feac433dffb986c7484643233232e11fa893634d0c7fc3bd9090500000000000030820505308202eda00302010202104ba85293f79a2fa273064ba8048d75d0300d06092a864886f70d01010b0500304f310b300906035504061302555331293027060355040a1320496e7465726e65742053656375726974792052657365617263682047726f7570311530130603550403130c4953524720526f6f74205831301e170d3234303331333030303030305a170d3237303331323233353935395a3033310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310c300a0603550403130352313030820122300d06092a864886f70d01010105000382010f003082010a0282010100cf57e5e6c45412edb447fec92758764650288c1d3e88df059dd5b51829bdddb55abffaf6cea3beaf00214b625a5a3c012fc55803f689ff8e1143ebc1b5e01407968f6f1fd7e7ba8139097565b7c2af185b372628e7a3f4072b6d1affab58bc95ae40ffe9cb57c4b55b7f780d1861bc17e754c6bb4991cd6e18d18085eea66536bc74eabc504ceafc21f338169394bab0d36b3806cd16127aca5275c8ad76b2c29c5d98455c6f617bc62dee3c13528601d957e6381cdf8db51f92919ae74a1ccc45a87255f0b0e6a307ecfda71b669e3f488b71847158c93afaef5ef25b442b3c74e78fb247c1076acd9ab70d96f712812651540aec61f6f7f5e2f28ac8950d8d0203010001a381f83081f5300e0603551d0f0101ff040403020186301d0603551d250416301406082b0601050507030206082b0601050507030130120603551d130101ff040830060101ff020100301d0603551d0e04160414bbbcc347a5e4bca9c6c3a4720c108da235e1c8e8301f0603551d2304183016801479b459e67bb6e5e40173800888c81a58f6e99b6e303206082b0601050507010104263024302206082b060105050730028616687474703a2f2f78312e692e6c656e63722e6f72672f30130603551d20040c300a3008060667810c01020130270603551d1f0420301e301ca01aa0188616687474703a2f2f78312e632e6c656e63722e6f72672f300d06092a864886f70d01010b0500038202010092b1e74137eb799d81e6cde225e13a20e9904495a3815ccfc35dfdbda070d5b19628220bd2f228cf0ce7d4e6438c24221dc14292d109af9f4bf4c8704f2016b15add01f61ff81f616b1427b0728d63aeeee2ce4bcf37ddbba3d4cde7ad50adbdbfe3ec3e6236709931a7e88dddea62e212aef59cd43d2c0caad09c79beea3d5c446e9631635a7dd67e4f24a04b057f5e6fd2d4ea5f334b13d657b6cade51b85da3098274fdc7789eb3b9ac16da4a2b96c3b68b628ff97419a29e03dee96f9bb00fd2a05af6855cc204b7c8d54e32c4bf045dbc29f6f7818f0c5d3c53c940908bfbb60865b9a421d509e51384843782ce1028fc76c206257a46524dda5372a4273f6270acbe694800fb670fdb5ba1e8d703212dd7c9f69942398343df770a1208f125d6ba9419541888a5c58ee11a9993796bec1cf93140b0cc3200df9f5ee7b492ab9082918d0de01e95ba593b2e4b5fc2b74635523906c0bdaaac52c122a0449799f70ca021a7a16c714716170168c0caa62665047cb3aec9e79455c26f9b3c1ca9f92ec5201af076e0beec18d64fd825fb7611e8bfe6210fe8e8ccb5b6a7d5b8f79f41cf6122466a83b668972e7cea4e95db23eb2ec82b2884a460e949f4442e3bf9ca625701e25d9016f9c9fc7a23488ea6d58172f128fa5dcefbed4e738f942ed241949899dba7af705ff5befb0220bf66276cb4adfa75120b2b3ece039e000000000000000000450000000000000003001741048b68632f53328caddef6fd3bd7fb941e86817baa8c253b208c244842ecabef403f0ecfff9b8677be3126b746b74e87fcfd07c7dcde3630c184ddf2b6f8a751b40600000000010000000000009d5146d5eacf609424a546a7b5532f54b60477c42ef1d511f2043da4d477dc19cc4dffb952bcc2a7754fbd0d58e2bc661a22cb037884bb796a59f7a6174e9f6c83dd800348dc6003135b40a2d29f63e9dc3b3f58092d12e51d831d0ae6703d8da918608c9e16516a7d702124ac898960cb7715d69219913d2d67284075a3480516c92fe6f28755428edf2fa92b0ed7a85631c346fc967e684ae417c41b70eb4971fe48b9139d00f0f7039ae7dd2724287c977ab906866e8cd59e6d0a08b33480736174d338b7773556404b97233dbec2bb0fd4cf188d28803d1d6468ddbdf11fedcf46ad0c4410661d5d198a3c7c28b2d81cbf8e4903edfa63de5caececda0035933d5b159e211a21317fa891cc4fdb5d7a55ca2c420759e72a39a5652212403c035ed659e636c81f1b36c4de9d53e36c9c8bea8d58a0303ec6f1525070ba9f43e000000000000000c00000000000000010000000000000084000000000000008500000000000000000000000000000001000000000000000d96ea206d6cb514d4a521403a8f703df35a343096122e178bc371f4e6f977f8b80f00000000000000010000000000000087000000000000008800000000000000000000000000000001000000000000000a3ea7ca7907af7a044eda999f335e90be84d922f9ba85be940150b43a8bb8985b0d00000000000000010000000000000085000000000000008600000000000000000000000000000001000000000000000aa2978b41a6fc1cdcecad50e11a8ced659c5488a1fd1c398236ddee36ac4fb13c0b00000000000000010000000000000074000000000000007500000000000000000000000000000001000000000000000af8a18f79bb1e69ed549129fc14446b219ff2dd9105cdcffbc259e3d877bd12501900000000000000010000000000000013010000000000003e0100000000000001000000000000002b000000000000005374726963742d5472616e73706f72742d53656375726974793a206d61782d6167653d31353736383030304c1cb0fcb15fdc9f6a3caa4e5653bc0d00717fc341bd9d28a3370751d824ad8a300000000000000001000000000000003f010000000000004001000000000000010000000000000001000000000000000a8195e9e6fb4776adad311559b8258b3e4aa71d4468e99f76d491ac6de654614c130000000000000001000000000000006c00000000000000860000000000000001000000000000001a000000000000005472616e736665722d456e636f64696e673a206368756e6b656493951defb16681d7e39b835ccf7c1ff00f55f6bab0665298cfc5d499e08aba592f0000000000000001000000000000003e010000000000003f01000000000000010000000000000001000000000000000d19eb18e0780cc4bd5f52a5462ebad35d1286aa0be47e5a018f61e25b26099b910300000000000000010000000000000000000000000000002b0000000000000000000000000000002b000000000000004745542068747470733a2f2f73776170692e6465762f6170692f70656f706c652f3120485454502f312e3191f6427b0957d686f9d019c78a4b759dc73ca58d23012ede5036f5318265afe73200000000000000010000000000000041010000000000004201000000000000010000000000000001000000000000000a185f1b2cb31096c5c0b5dee69bc955921e2af2fe004e538fbbcc8683df4986fe2a000000000000000100000000000000cd00000000000000ce00000000000000010000000000000001000000000000000a7e6e59de6e12f0d94b46c369ed893368a9d31bd835a5adbd399f2b938ec60fef2b000000000000000100000000000000f600000000000000f700000000000000010000000000000001000000000000000da561eb1758111ed2f7b7668f71d217c4c74f7d1c5801cd9bbe8e35d294eed47c0a00000000000000010000000000000073000000000000007400000000000000000000000000000001000000000000000d391781437999aab0326c51a126148d35b9269c2c284892b4b0b3d132e3009f0416000000000000000100000000000000b100000000000000cc0000000000000001000000000000001b00000000000000582d4672616d652d4f7074696f6e733a2053414d454f524947494e34bf35470e84cd2d9be6e420614d8eb6156b3cf392cf7d31168e1cecdddbd49729000000000000000100000000000000cc00000000000000cd00000000000000010000000000000001000000000000000d4f250e99698e7a42429d7697d3430ee6d97946d1ab545aa2f78dabef14a35443260000000000000001000000000000009a000000000000009b00000000000000010000000000000001000000000000000a2ad5b887a7cbdb9c0c063f37e45c373934e8dae42663414e6368da3ac2e4ab4028000000000000000100000000000000b000000000000000b100000000000000010000000000000001000000000000000a9ade1262ce9d20636872c5195612797fc63c5b128b508b731f2fa5f00c13eec8050000000000000001000000000000002c000000000000002d00000000000000000000000000000001000000000000000a2db755cd1a725ceca8f82dbaaa511f6148cb5503751ef9576e2df9f6291f1407040000000000000001000000000000002b000000000000002c00000000000000000000000000000001000000000000000d78f1fa51a78c78cedb3b417c049cf5a9cc21b8a88909af2aa3dcba6a8c8879b82d00000000000000010000000000000011010000000000001201000000000000010000000000000001000000000000000dc1be20726463291e024c5cee58f71c048b51293ed506fcd6e16cd225e3840970140000000000000001000000000000008800000000000000990000000000000001000000000000001100000000000000436f6e6e656374696f6e3a20636c6f7365c2babe38c5b1dd0f05083790b3a517b314c2856b2e514b334f7f37809c34ab4d17000000000000000100000000000000ce00000000000000f60000000000000001000000000000002800000000000000455461673a20226565333938363130343335633332386634643061346531623064326637626263221fa41cfa8a43f9c429362030ebfc485b7f22760be68a857ba363ca07f4d5c3841a00000000000000010000000000000000000000000000000f0000000000000001000000000000000f00000000000000485454502f312e3120323030204f4b5fd6cde8f919ba0651fc0fa175b1e8b0757c6059614797bee69ab28cb1306b0a1c00000000000000010000000000000010000000000000001100000000000000010000000000000001000000000000000a8d5e96737b598e8b0e066b3d41d6c75403567f8f05a1507a8aa5d57a537586d8220000000000000001000000000000006b000000000000006c00000000000000010000000000000001000000000000000ac4f99df5c308cf1ad9767055247b6bc178b58ce5083386ad7274e6ace5aacd3a2300000000000000010000000000000086000000000000008700000000000000010000000000000001000000000000000d3cb4641d2933f9188a63e9a972bfd6ed61a6072cb04b8a65bb3cef1114c07b2e39000000000000000100000000000000d303000000000000d403000000000000010000000000000001000000000000000d6809f86ac50d7ee3571e5fa6d62174fc7ea40f85b078387625c0057f01ec54d12e00000000000000010000000000000012010000000000001301000000000000010000000000000001000000000000000a824f8ac9162621f92208b25371907f6275d1b4dae50bca84deee6b79e42414b1120000000000000001000000000000004c000000000000006a0000000000000001000000000000001e00000000000000436f6e74656e742d547970653a206170706c69636174696f6e2f6a736f6e9ce594f77e4978550932f5d37bb61840ecce13cbe72423e9c223b1778ab4be5837000000000000000100000000000000d103000000000000d203000000000000010000000000000001000000000000000dc3b9d065640a3a95ff63029bc7d3f665f2bb0d0cb853aa0a3eb49f85b51968b13a000000000000000100000000000000d403000000000000d503000000000000010000000000000001000000000000000a0f807fcc122d881d8c975b095ff3ab1451c0582f44a87a8b412c68df8111d7121b0000000000000001000000000000000f000000000000001000000000000000010000000000000001000000000000000d38f49f3d34cfa61378015e4452f7cdf5daa757d5f90adfd5f90e3885c624ff7c0100000000000000010000000000000040000000000000005e0000000000000000000000000000001e00000000000000636f6e74656e742d747970653a206170706c69636174696f6e2f6a736f6eea8a9887350c64d961458aeb624f9cacbe5a3eabfc27fe586370445ad5b16a69150000000000000001000000000000009b00000000000000af0000000000000001000000000000001400000000000000566172793a204163636570742c20436f6f6b6965fc5a7ad9d7076f630ced01ffade7c60452750b0221921196c0128b9ae2c14d79080000000000000001000000000000005e000000000000005f00000000000000000000000000000001000000000000000dc223c0a0710aa6aafe2b9b63fc55c75e323c54ac09aa26d697b26e7a953d84a0000000000000000001000000000000002d000000000000003e0000000000000000000000000000001100000000000000636f6e6e656374696f6e3a20636c6f7365b1ca8bada5de8742fb4b1529cadaa44b8846172f50640b6ad8c841cf7cb71e051100000000000000010000000000000027000000000000004a0000000000000001000000000000002300000000000000446174653a204d6f6e2c2031322041756720323032342030393a30363a313420474d54d4182cd518018b0682322fb898162712db26c55b65e4a7e62e676a1cac51d0a0060000000000000001000000000000003e000000000000003f00000000000000000000000000000001000000000000000d7535c4bd59ea5028214ca997f9959c0dcef89b2c22fbad6e5c732eb4a8c201cd1000000000000000010000000000000011000000000000002500000000000000010000000000000014000000000000005365727665723a206e67696e782f312e31362e31dde166c44d35970fe58402beb14a2b8c2c76b8f9bda5acc070532f13107be1041e00000000000000010000000000000026000000000000002700000000000000010000000000000001000000000000000af89d3abf1d5865424fdb77a64717a8d91ee3cea0ee82b30599ed536ec55aa1f53100000000000000010000000000000040010000000000004101000000000000010000000000000001000000000000000d1aaafceee08d60020624b60a0d662447b5bd312d59c137b9c515e80c104fbd74200000000000000001000000000000004b000000000000004c00000000000000010000000000000001000000000000000a5840710fc7c0c7aa80c18bae02039128b0c3812783c82aa93be577915d3f70d73400000000000000010000000000000046010000000000004701000000000000010000000000000001000000000000000a12219d2d9de8ac0f025793a72012d193b9a1e88645fe728fa442ff67af3406fc0e00000000000000010000000000000086000000000000008700000000000000000000000000000001000000000000000d23ee390e5a382e87e2ff17b8bd3fba8217cc22f89258bf2803eda68d9e3ffbfb18000000000000000100000000000000f800000000000000110100000000000001000000000000001900000000000000416c6c6f773a204745542c20484541442c204f5054494f4e531c00a0bcc34c4e940f89a1b3de0a3b84434dee9e3c334ab2d88028a1e629697e3c0000000000000001000000000000007b010000000000008f010000000000000100000000000000140000000000000022686169725f636f6c6f72223a22626c6f6e64229369bfd64d9a4d0e86ccc6c7f445c02a58f73668af8849561909c2a9ac51514127000000000000000100000000000000af00000000000000b000000000000000010000000000000001000000000000000d49237ad294a8a63cae251b6d2fa87d40a07a74a9409d9e3fe36e3d709297c3f535000000000000000100000000000000ce03000000000000cf03000000000000010000000000000001000000000000000dc81c989bbafe60febde627f6a168e52fa88f7a5c92eca55c1019b6de1a5d86da36000000000000000100000000000000cf03000000000000d003000000000000010000000000000001000000000000000afd886fa5c8607003090aa3fab243fae4616c487dd15d81dd802f8a4bb67907b43300000000000000010000000000000045010000000000004601000000000000010000000000000001000000000000000d6e68c045711cf1e6af7f0f4e6d08bd228079d08848919469d3868732b6872c7e210000000000000001000000000000006a000000000000006b00000000000000010000000000000001000000000000000d7352c55880b9df7aa73a1b1d190b4a90efb11adfcb469c90ff9c8981000cb60c020000000000000001000000000000007500000000000000840000000000000000000000000000000f00000000000000686f73743a2073776170692e6465768cb75633fd51040f767560709611c315317d6413582979d4a64d5e83a51a35332400000000000000010000000000000087000000000000008800000000000000010000000000000001000000000000000a153fa7b21dfb2773ff3762b00af6821e2d0c5ec8bf533aa4f43d1f57c18b504d090000000000000001000000000000005f000000000000006000000000000000000000000000000001000000000000000aa7dfbe3c9a5bad316bb4fb9e270de851674cd014e2f599873175fcbdf58fe468070000000000000001000000000000003f000000000000004000000000000000000000000000000001000000000000000a5a6ed55ff196b48e1cfe516d9d8edd3524ec83cea8e012ad30f6cb7d9cad59a73d0000000000000001000000000000009001000000000000a3010000000000000100000000000000130000000000000022736b696e5f636f6c6f72223a226661697222ed76c9d8a2592a8558e125d57ea4ebc09c7c8c2fb295861a67ddb4feaa6362273b00000000000000010000000000000048010000000000005f0100000000000001000000000000001700000000000000226e616d65223a224c756b6520536b7977616c6b65722224d38a6c588dbd4dafd2537e4fd30524496dc27e883f5fc1bf3ee963687c52dc2500000000000000010000000000000099000000000000009a00000000000000010000000000000001000000000000000de63e2efda1904a47fbcc650d33a69a52ccc4790c0f9c4d1ce6a981bf7d599a7038000000000000000100000000000000d203000000000000d303000000000000010000000000000001000000000000000a144f0599d0f524c0c13420fcf3b0c95c4d47541cad82f7fd6fbb8b6e8bf8dc931d00000000000000010000000000000025000000000000002600000000000000010000000000000001000000000000000debc5da6e2952358474248c5271436e6cf125ff89e62de8b557936bd07d6eb2681f0000000000000001000000000000004a000000000000004b00000000000000010000000000000001000000000000000dd5a8b218331287f4c1160b03144cb80f3ab4c6dccfee0b7f4844b50c81ee86262c000000000000000100000000000000f700000000000000f800000000000000010000000000000001000000000000000afa4fc1b6cb445a8137ffb39b2c9851ab21e5ae69e344da19be301a31f77d299000000000000000003e00000000000000`;
    const proof = (await new TlsProof(proofHex)) as _TlsProof;
    const result = await proof.verify({
      typ: 'P256',
      key: `-----BEGIN PUBLIC KEY-----\nMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEBv36FI4ZFszJa0DQFJ3wWCXvVLFr\ncRzMG5kaTeHGoSzDu6cFqx3uEWYpFGo6C0EOUgf+mEgbktLrXocv5yHzKg==\n-----END PUBLIC KEY-----\n`,
    });
    console.timeEnd('verify');

    console.log(result);
    assert(result.sent.includes('host: swapi.dev'));
    assert(!result.sent.includes('secret: test_secret'));
    assert(result.recv.includes('"name":"Luke Skywalker"'));
    assert(result.recv.includes('"hair_color":"blond"'));
    assert(result.recv.includes('"skin_color":"fair"'));

    // @ts-ignore
    document.getElementById('simple-verify').textContent = 'OK';
  } catch (err) {
    console.log('caught error from wasm');
    console.error(err);

    // @ts-ignore
    document.getElementById('simple-verify').textContent = err.message;
  }
})();
