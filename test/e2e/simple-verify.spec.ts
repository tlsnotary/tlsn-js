import { Presentation as _Presentation } from '../../src/lib';
// import { assert } from '../utils';
import * as Comlink from 'comlink';
import { Transcript } from '../../src/lib';
import { assert } from '../utils';

const { init, Presentation }: any = Comlink.wrap(
  // @ts-ignore
  new Worker(new URL('../worker.ts', import.meta.url)),
);

(async function verify_simple() {
  try {
    await init({ loggingLevel: 'Debug' });

    console.time('verify');
    const proofHex = `014000000000000000109ae8b3907143d7734d0a5f66fe57481c079d596604746c3bf9b76800bf697411c43d1905998b1a9693c89b3fe8b576a706e8173ff22d5c025ae4616cfbf06aabc22d4649337585ee95218a97b8e221000000000220000000000000006a811d58d79039e5d0d80196090114e5e51f0837bb750b9cc2936d0b0cf24c0e00000000012100000000000000037b48f19c139b6888fb5e383a4d72c2335186fd5858e7ae743ab4bf8e071b06e701000000d855d0670000000000000000b5000000d503000002000000000000004100000000000000046c388c06a862e23db4d62ff162be3d1e60c48029a83f78599e5c84fcf57c7ffa539bf41432e1bc6a986ecf220915bf0708d52043f62a6f138cacf309f1503bc603000000022000000000000000ba9f8b6bd2e47cc7e28b460b132056e9bd494b8e5ef0ff9121ecff65f6b381740104000000022000000000000000a367c9b83532f88d7e2fdf40c4434cc3fb43426d43da23a1e4adc9958f286a0ff99f0ab07b8a280e0abf31811715bcabf644f1b71210fe4216ace39e60b2382f7191e3b0db8eb78449a7cff361cede680000000000000000020500000000000000000000000000000001090000000000000073776170692e6465760200000000000000e804000000000000308204e4308203cca003020102021204f66b8fb50fd14617ca0fae113cb63a1125300d06092a864886f70d01010b05003033310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310c300a06035504031303523130301e170d3235303131343036313534355a170d3235303431343036313534345a3014311230100603550403130973776170692e64657630820122300d06092a864886f70d01010105000382010f003082010a0282010100a8283f4754f222fcb1ad77c39e1c810d04d7e530b17c7b294298b5c125914ae51ba4d85bf372ea84f899ff8ab501495a8de115e64e66baf79e27b58e9543fd15fc1f68df9027c75516cced3fe74f165029e8da10ff6ee4cdee2ba45a3b2191f335e02247cefdc21cdf2de1951c6ae3db5ff58320e3239da6951162be0b96ce612516dc03509e5a9765316f0ad3560c042d284cec0d1eed5d15fe9f3f5894f95fc9186b3d802ada8c3bfa401051aef479efa2851c5f091d43417ac907792d31f55debdc1ffbfe2dfe9ee000f41df97b9d095bb569fe5e392a890ccbf34eea38ea13f51483ccb38d12408fb01d52067115e9a74b82ee62f3da65865ac84fd222770203010001a382020f3082020b300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030106082b06010505070302300c0603551d130101ff04023000301d0603551d0e0416041409ecccc96b577e0066a5d39dc32624fc9eaf0b97301f0603551d23041830168014bbbcc347a5e4bca9c6c3a4720c108da235e1c8e8305706082b06010505070101044b3049302206082b060105050730018616687474703a2f2f7231302e6f2e6c656e63722e6f7267302306082b060105050730028617687474703a2f2f7231302e692e6c656e63722e6f72672f30140603551d11040d300b820973776170692e64657630130603551d20040c300a3008060667810c01020130820106060a2b06010401d6790204020481f70481f400f2007700cf1156eed52e7caff3875bd9692e9be91a71674ab017ecac01d25b77cecc3b080000019463a9bb140000040300483046022100f03f68e5ef10637da98c598a1398692005e2504998a6d014e77204eff596557f022100ff44584e7a7df31a1c1652270ae0d5a9ab49a6d84083aa1d0f4e1f11d747737b007700134adf1ab5984209780c6fef4c7a91a416b72349ce58576adfaedaa7c2abe0220000019463a9bd1e0000040300483046022100e6fd515324b19cf2d24a73f22ac74e7a8f3c0b25ac9328bf118e0ec834c8e68802210094b10f2a6e9aef6251d8873a304b4179c8079f22aab77bd4f72e67b2cca1ad90300d06092a864886f70d01010b0500038201010032cc31a8a25973a96223b9aa0f6d49548beb22dab289c2d63df1e2bcbfba15709cddf3704179b31e91ae5dc82bf9e028ff07ffa62c92b621a294b5a8aae4902d715afd3cc3659eda5d7732610110674a0481a1e225e17be048aa4dcb8e5323793ed51ac35de61fbd720445dd880be1207048e69864e8fbc49ad0198d1b9b877c1051d6214b5eb86bb6dbfd35b3d1a3fec8c8a5c3ebb3c5a4e854e4493a19ed9a5be9003857938787ffac425f343b51d6cc4b05edd6036b4a5caada4dc889c5ae42ba712282da1218f3cf0f1eace2ec88fd49de4dc5cfe949f1cc4e3f150412a07825357a7c48ec7284692e8da44feb2605def11e45e16ab30f19dbf4364400cb090500000000000030820505308202eda00302010202104ba85293f79a2fa273064ba8048d75d0300d06092a864886f70d01010b0500304f310b300906035504061302555331293027060355040a1320496e7465726e65742053656375726974792052657365617263682047726f7570311530130603550403130c4953524720526f6f74205831301e170d3234303331333030303030305a170d3237303331323233353935395a3033310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310c300a0603550403130352313030820122300d06092a864886f70d01010105000382010f003082010a0282010100cf57e5e6c45412edb447fec92758764650288c1d3e88df059dd5b51829bdddb55abffaf6cea3beaf00214b625a5a3c012fc55803f689ff8e1143ebc1b5e01407968f6f1fd7e7ba8139097565b7c2af185b372628e7a3f4072b6d1affab58bc95ae40ffe9cb57c4b55b7f780d1861bc17e754c6bb4991cd6e18d18085eea66536bc74eabc504ceafc21f338169394bab0d36b3806cd16127aca5275c8ad76b2c29c5d98455c6f617bc62dee3c13528601d957e6381cdf8db51f92919ae74a1ccc45a87255f0b0e6a307ecfda71b669e3f488b71847158c93afaef5ef25b442b3c74e78fb247c1076acd9ab70d96f712812651540aec61f6f7f5e2f28ac8950d8d0203010001a381f83081f5300e0603551d0f0101ff040403020186301d0603551d250416301406082b0601050507030206082b0601050507030130120603551d130101ff040830060101ff020100301d0603551d0e04160414bbbcc347a5e4bca9c6c3a4720c108da235e1c8e8301f0603551d2304183016801479b459e67bb6e5e40173800888c81a58f6e99b6e303206082b0601050507010104263024302206082b060105050730028616687474703a2f2f78312e692e6c656e63722e6f72672f30130603551d20040c300a3008060667810c01020130270603551d1f0420301e301ca01aa0188616687474703a2f2f78312e632e6c656e63722e6f72672f300d06092a864886f70d01010b0500038202010092b1e74137eb799d81e6cde225e13a20e9904495a3815ccfc35dfdbda070d5b19628220bd2f228cf0ce7d4e6438c24221dc14292d109af9f4bf4c8704f2016b15add01f61ff81f616b1427b0728d63aeeee2ce4bcf37ddbba3d4cde7ad50adbdbfe3ec3e6236709931a7e88dddea62e212aef59cd43d2c0caad09c79beea3d5c446e9631635a7dd67e4f24a04b057f5e6fd2d4ea5f334b13d657b6cade51b85da3098274fdc7789eb3b9ac16da4a2b96c3b68b628ff97419a29e03dee96f9bb00fd2a05af6855cc204b7c8d54e32c4bf045dbc29f6f7818f0c5d3c53c940908bfbb60865b9a421d509e51384843782ce1028fc76c206257a46524dda5372a4273f6270acbe694800fb670fdb5ba1e8d703212dd7c9f69942398343df770a1208f125d6ba9419541888a5c58ee11a9993796bec1cf93140b0cc3200df9f5ee7b492ab9082918d0de01e95ba593b2e4b5fc2b74635523906c0bdaaac52c122a0449799f70ca021a7a16c714716170168c0caa62665047cb3aec9e79455c26f9b3c1ca9f92ec5201af076e0beec18d64fd825fb7611e8bfe6210fe8e8ccb5b6a7d5b8f79f41cf6122466a83b668972e7cea4e95db23eb2ec82b2884a460e949f4442e3bf9ca625701e25d9016f9c9fc7a23488ea6d58172f128fa5dcefbed4e738f942ed241949899dba7af705ff5befb0220bf66276cb4adfa75120b2b3ece039e0600000000010000000000001340136ac3593d6cac6b156141a412f7c26d88c414249d8eb26b495cf36fbb9a0a679d9c3d0306c3cc68118ba60e7befb62b43715e763b50ffc32000b63a24a0f928ef8fc51fbbd91615a8bb7cf98810c52a25d3cef3499f048fef0a9ef44794bae86b6698103507bfc838028facdb32c4d3f3b01a26662dc3c840acd93d412a0c9c6cba4e3133d6dadde90e097195d9e4c5c6ba573e11819860756c24b5ed600eed3ae1819eaf2ba23fd62162da87b4d4dd8bac146590c7f57b4f8aa46600b12044d1cd17b1751211c7549d2a464b396224519310def7f7b01b950e26543edcee735340c339c147de3f961b49b458ad32266f85faf39fbc36ce5e2412f56ba500000000c9285cd9d2bc40cee7f7542634332e7d6afd4a63a7030d03db67b5654483e45273367e9eb0415c9a948492cf119fe3ec6f01ce5f3d48aa43e7fe8b2f50f1300c000000004100000000000000046c388c06a862e23db4d62ff162be3d1e60c48029a83f78599e5c84fcf57c7ffa539bf41432e1bc6a986ecf220915bf0708d52043f62a6f138cacf309f1503bc6bee89f04be30bf3f49fc17b3e6c493880101020d0000000000000000000000000000000d0000000000000009000000000000000000000001000000000000005100000000000000b50000000000000064000000000000000d0a636f6e74656e742d747970653a206170706c69636174696f6e2f6a736f6e0d0a636f6e74656e742d6c656e6774683a2032350d0a636f6e6e656374696f6e3a20636c6f73650d0a0d0a7b2268656c6c6f223a22776f726c64222c226f6e65223a317da3542f67365c8a7e84c71c17eb2211f707000000000000000100000001000000000000009b00000000000000b1000000000000001600000000000000566172793a204163636570742c20436f6f6b69650d0a7662b32dffa2f1c824d41cb9d68921740a00000000000000010000000100000000000000f80000000000000011010000000000001900000000000000416c6c6f773a204745542c20484541442c204f5054494f4e5342884d85d33f7eac21a8e5b2af428b2800000000000000000100000001000000000000006c0000000000000088000000000000001c000000000000005472616e736665722d456e636f64696e673a206368756e6b65640d0a0d7e3c01419c1ed446f91a9fd0e3efc80c000000000000000100000001000000000000004c000000000000006c000000000000002000000000000000436f6e74656e742d547970653a206170706c69636174696f6e2f6a736f6e0d0adff10362be12286a098c14cba5e9534a0100000000000000010000000100000000000000ce00000000000000f6000000000000002800000000000000455461673a20226565333938363130343335633332386634643061346531623064326637626263227bf1049cd876e1bb6ae72e33bcc0f4290b00000000000000010000000100000000000000cc01000000000000db010000000000000f000000000000002267656e646572223a226d616c6522eb572481867376e9be14dcce6703815e0200000000000000010000000100000000000000b100000000000000cc000000000000001b00000000000000582d4672616d652d4f7074696f6e733a2053414d454f524947494e1eafb6b4f80e8eaa13ecb6b73bb94fac080000000000000001000000010000000000000088000000000000009b000000000000001300000000000000436f6e6e656374696f6e3a20636c6f73650d0ae5d4b02c641345677e9a4d08e2c8830d050000000000000000000000010000000000000000000000000000003e000000000000003e000000000000004745542068747470733a2f2f73776170692e6465762f6170692f70656f706c652f3120485454502f312e310d0a686f73743a2073776170692e6465760d0a4edcdaa389b70f77d4cf9ee0a93f64ff040000000000000001000000010000000000000048010000000000005f010000000000001700000000000000226e616d65223a224c756b6520536b7977616c6b657222c09dac022f4092dc9f18ece833eec2140600000000000000010000000100000000000000000000000000000011000000000000001100000000000000485454502f312e3120323030204f4b0d0a434e09486def669bf0bd5901efebb7f1030000000000000001000000010000000000000013010000000000003e010000000000002b000000000000005374726963742d5472616e73706f72742d53656375726974793a206d61782d6167653d313537363830303053c3a8287b97e9408d8d432d7c8ea1070000000000000000`;
    const proof = (await new Presentation(proofHex)) as _Presentation;
    const result = await proof.verify();
    console.timeEnd('verify');
    const transcript = new Transcript({
      sent: result.transcript.sent,
      recv: result.transcript.recv,
    });

    const sent = transcript.sent();
    const recv = transcript.recv();
    const json = await proof.json();
    assert(json.version === '0.1.0-alpha.8');
    assert(new URL(json.meta.notaryUrl!).protocol === 'http:');
    assert(sent.includes('host: swapi.dev'));
    assert(!sent.includes('secret: test_secret'));
    assert(recv.includes('"name":"Luke Skywalker"'));
    assert(recv.includes('"gender":"male"'));

    // @ts-ignore
    document.getElementById('simple-verify').textContent = 'OK';
  } catch (err) {
    console.log('caught error from wasm');
    console.error(err);

    // @ts-ignore
    document.getElementById('simple-verify').textContent = err.message;
  }
})();
