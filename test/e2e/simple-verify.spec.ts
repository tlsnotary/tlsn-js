import { Presentation as _Presentation } from '../../src/lib';
// import { assert } from '../utils';
import * as Comlink from 'comlink';
import { Transcript } from '../../src/lib';
import { assert } from '../utils';

const { init, Presentation }: any = Comlink.wrap(
  // @ts-ignore
  new Worker(new URL('../worker.ts', import.meta.url)),
);

(async function verify_simple() {
  try {
    await init({ loggingLevel: 'Debug' });

    console.time('verify');
    const proofHex = `014000000000000000110ed7f2977d76647609c1e467ef0b73d9bd8907286f001c4891a0d68263a95d2b5afa0cd3c6dbba2e04a0a8c2a6784b8d334fe7586c56982242adaa8ee1935a6a235f4d3761a0627b50c9c01589abaa00000000022000000000000000606388b4d1fe166309cef496f59ceeb07f3f86b279293436436cabf11d7c7e2c00000000012100000000000000037b48f19c139b6888fb5e383a4d72c2335186fd5858e7ae743ab4bf8e071b06e7010000006646d0670000000000000000b5000000d50300000200000000000000410000000000000004161e913620e2ae3fc961010e4af641da2e4e2a77435d3300a82660528725db0dbf4686209256265f35913e95cef49993b36cb89c88900d3f6c05d3a0271befb10300000002200000000000000056816cde0b893dad14a21f74818a594cbf40fdb4175d7739453b8bf0fb3896840104000000022000000000000000abaea309a523eef5867d714d0783746ada520f695e2252f7d15b24ac93171237a7e41d7b542a98f10b7fbc8bbcf26af98bc985a90347fbe3c0770a3d54bc592ffddceffa1a1c9e2db984a9035d4ae8bb0000000000000000020500000000000000000000000000000001090000000000000073776170692e6465760200000000000000e804000000000000308204e4308203cca003020102021204f66b8fb50fd14617ca0fae113cb63a1125300d06092a864886f70d01010b05003033310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310c300a06035504031303523130301e170d3235303131343036313534355a170d3235303431343036313534345a3014311230100603550403130973776170692e64657630820122300d06092a864886f70d01010105000382010f003082010a0282010100a8283f4754f222fcb1ad77c39e1c810d04d7e530b17c7b294298b5c125914ae51ba4d85bf372ea84f899ff8ab501495a8de115e64e66baf79e27b58e9543fd15fc1f68df9027c75516cced3fe74f165029e8da10ff6ee4cdee2ba45a3b2191f335e02247cefdc21cdf2de1951c6ae3db5ff58320e3239da6951162be0b96ce612516dc03509e5a9765316f0ad3560c042d284cec0d1eed5d15fe9f3f5894f95fc9186b3d802ada8c3bfa401051aef479efa2851c5f091d43417ac907792d31f55debdc1ffbfe2dfe9ee000f41df97b9d095bb569fe5e392a890ccbf34eea38ea13f51483ccb38d12408fb01d52067115e9a74b82ee62f3da65865ac84fd222770203010001a382020f3082020b300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030106082b06010505070302300c0603551d130101ff04023000301d0603551d0e0416041409ecccc96b577e0066a5d39dc32624fc9eaf0b97301f0603551d23041830168014bbbcc347a5e4bca9c6c3a4720c108da235e1c8e8305706082b06010505070101044b3049302206082b060105050730018616687474703a2f2f7231302e6f2e6c656e63722e6f7267302306082b060105050730028617687474703a2f2f7231302e692e6c656e63722e6f72672f30140603551d11040d300b820973776170692e64657630130603551d20040c300a3008060667810c01020130820106060a2b06010401d6790204020481f70481f400f2007700cf1156eed52e7caff3875bd9692e9be91a71674ab017ecac01d25b77cecc3b080000019463a9bb140000040300483046022100f03f68e5ef10637da98c598a1398692005e2504998a6d014e77204eff596557f022100ff44584e7a7df31a1c1652270ae0d5a9ab49a6d84083aa1d0f4e1f11d747737b007700134adf1ab5984209780c6fef4c7a91a416b72349ce58576adfaedaa7c2abe0220000019463a9bd1e0000040300483046022100e6fd515324b19cf2d24a73f22ac74e7a8f3c0b25ac9328bf118e0ec834c8e68802210094b10f2a6e9aef6251d8873a304b4179c8079f22aab77bd4f72e67b2cca1ad90300d06092a864886f70d01010b0500038201010032cc31a8a25973a96223b9aa0f6d49548beb22dab289c2d63df1e2bcbfba15709cddf3704179b31e91ae5dc82bf9e028ff07ffa62c92b621a294b5a8aae4902d715afd3cc3659eda5d7732610110674a0481a1e225e17be048aa4dcb8e5323793ed51ac35de61fbd720445dd880be1207048e69864e8fbc49ad0198d1b9b877c1051d6214b5eb86bb6dbfd35b3d1a3fec8c8a5c3ebb3c5a4e854e4493a19ed9a5be9003857938787ffac425f343b51d6cc4b05edd6036b4a5caada4dc889c5ae42ba712282da1218f3cf0f1eace2ec88fd49de4dc5cfe949f1cc4e3f150412a07825357a7c48ec7284692e8da44feb2605def11e45e16ab30f19dbf4364400cb090500000000000030820505308202eda00302010202104ba85293f79a2fa273064ba8048d75d0300d06092a864886f70d01010b0500304f310b300906035504061302555331293027060355040a1320496e7465726e65742053656375726974792052657365617263682047726f7570311530130603550403130c4953524720526f6f74205831301e170d3234303331333030303030305a170d3237303331323233353935395a3033310b300906035504061302555331163014060355040a130d4c6574277320456e6372797074310c300a0603550403130352313030820122300d06092a864886f70d01010105000382010f003082010a0282010100cf57e5e6c45412edb447fec92758764650288c1d3e88df059dd5b51829bdddb55abffaf6cea3beaf00214b625a5a3c012fc55803f689ff8e1143ebc1b5e01407968f6f1fd7e7ba8139097565b7c2af185b372628e7a3f4072b6d1affab58bc95ae40ffe9cb57c4b55b7f780d1861bc17e754c6bb4991cd6e18d18085eea66536bc74eabc504ceafc21f338169394bab0d36b3806cd16127aca5275c8ad76b2c29c5d98455c6f617bc62dee3c13528601d957e6381cdf8db51f92919ae74a1ccc45a87255f0b0e6a307ecfda71b669e3f488b71847158c93afaef5ef25b442b3c74e78fb247c1076acd9ab70d96f712812651540aec61f6f7f5e2f28ac8950d8d0203010001a381f83081f5300e0603551d0f0101ff040403020186301d0603551d250416301406082b0601050507030206082b0601050507030130120603551d130101ff040830060101ff020100301d0603551d0e04160414bbbcc347a5e4bca9c6c3a4720c108da235e1c8e8301f0603551d2304183016801479b459e67bb6e5e40173800888c81a58f6e99b6e303206082b0601050507010104263024302206082b060105050730028616687474703a2f2f78312e692e6c656e63722e6f72672f30130603551d20040c300a3008060667810c01020130270603551d1f0420301e301ca01aa0188616687474703a2f2f78312e632e6c656e63722e6f72672f300d06092a864886f70d01010b0500038202010092b1e74137eb799d81e6cde225e13a20e9904495a3815ccfc35dfdbda070d5b19628220bd2f228cf0ce7d4e6438c24221dc14292d109af9f4bf4c8704f2016b15add01f61ff81f616b1427b0728d63aeeee2ce4bcf37ddbba3d4cde7ad50adbdbfe3ec3e6236709931a7e88dddea62e212aef59cd43d2c0caad09c79beea3d5c446e9631635a7dd67e4f24a04b057f5e6fd2d4ea5f334b13d657b6cade51b85da3098274fdc7789eb3b9ac16da4a2b96c3b68b628ff97419a29e03dee96f9bb00fd2a05af6855cc204b7c8d54e32c4bf045dbc29f6f7818f0c5d3c53c940908bfbb60865b9a421d509e51384843782ce1028fc76c206257a46524dda5372a4273f6270acbe694800fb670fdb5ba1e8d703212dd7c9f69942398343df770a1208f125d6ba9419541888a5c58ee11a9993796bec1cf93140b0cc3200df9f5ee7b492ab9082918d0de01e95ba593b2e4b5fc2b74635523906c0bdaaac52c122a0449799f70ca021a7a16c714716170168c0caa62665047cb3aec9e79455c26f9b3c1ca9f92ec5201af076e0beec18d64fd825fb7611e8bfe6210fe8e8ccb5b6a7d5b8f79f41cf6122466a83b668972e7cea4e95db23eb2ec82b2884a460e949f4442e3bf9ca625701e25d9016f9c9fc7a23488ea6d58172f128fa5dcefbed4e738f942ed241949899dba7af705ff5befb0220bf66276cb4adfa75120b2b3ece039e0600000000010000000000000ee9b1497a5856b8204d3dfc1f428718f893bef039c336aff7bd4915de50ef4bdf5a1ebb5a6fca72f5794a23da9d7d945bc3d6765fdfd9155201ea6919466534636f02c9995b839c24de0f04c7f6554fca8134ff497ac710b21bf23894dc12dbd4671c11f42bbf43609cfa9d15d549da56cda1ad486058377271f08cecf858c3da0aa458eb67a8cc5bab83a2923ac1db932d2f7416d7e191d4186e32fb495c3ddf195d103c7e9f71400a06939e96d85b3767fdde21521b9eedeccd4332127297719c130d680cd615f2d125bee70e65fda8094840753e1c125d7874519d0ec3083172cad089ebe33c27d7765240f4306f9fed9194ff1fff8a7235bf7aa49fe6c400000000bca993696203704f98c827a40e91cd752bf8fb11e928200baa712e7e8be044e47703e4d518bfbd2e51392d85539cd85f93f49a9eb59fd5ab74729c9cf288771500000000410000000000000004161e913620e2ae3fc961010e4af641da2e4e2a77435d3300a82660528725db0dbf4686209256265f35913e95cef49993b36cb89c88900d3f6c05d3a0271befb167c8677054a4771b8de55c8b18ea1dcd0101020d0000000000000000000000000000000d0000000000000009000000000000000000000001000000000000005100000000000000b50000000000000064000000000000000d0a636f6e74656e742d747970653a206170706c69636174696f6e2f6a736f6e0d0a636f6e74656e742d6c656e6774683a2032350d0a636f6e6e656374696f6e3a20636c6f73650d0a0d0a7b2268656c6c6f223a22776f726c64222c226f6e65223a317d796b2911d358e950d60b2568f724246307000000000000000100000001000000000000009b00000000000000b1000000000000001600000000000000566172793a204163636570742c20436f6f6b69650d0afdc98987c80b241b3a456dc16cddaf5f0a00000000000000010000000100000000000000f80000000000000011010000000000001900000000000000416c6c6f773a204745542c20484541442c204f5054494f4e535aa95398c36c613fdb83269a9216966300000000000000000100000001000000000000006c0000000000000088000000000000001c000000000000005472616e736665722d456e636f64696e673a206368756e6b65640d0ae8a6f0b940a2aab244462f35edc28a910c000000000000000100000001000000000000004c000000000000006c000000000000002000000000000000436f6e74656e742d547970653a206170706c69636174696f6e2f6a736f6e0d0ab4218d73658f678611fa77fd7b98375d0100000000000000010000000100000000000000ce00000000000000f6000000000000002800000000000000455461673a2022656533393836313034333563333238663464306134653162306432663762626322fd1ff5b6ed1dcd8fc67dba52e6133b170b00000000000000010000000100000000000000cc01000000000000db010000000000000f000000000000002267656e646572223a226d616c6522097c3b458954e0307c2bf490015fc9280200000000000000010000000100000000000000b100000000000000cc000000000000001b00000000000000582d4672616d652d4f7074696f6e733a2053414d454f524947494e5f4bbb7b6be1a6ec53bee0f0bf5c6d67080000000000000001000000010000000000000088000000000000009b000000000000001300000000000000436f6e6e656374696f6e3a20636c6f73650d0a1bb822e8b68a90ef3319359aa419c213050000000000000000000000010000000000000000000000000000003e000000000000003e000000000000004745542068747470733a2f2f73776170692e6465762f6170692f70656f706c652f3120485454502f312e310d0a686f73743a2073776170692e6465760d0a0c7605a42a9e467b9d9b34e3c73d3ca6040000000000000001000000010000000000000048010000000000005f010000000000001700000000000000226e616d65223a224c756b6520536b7977616c6b6572227ce4d9f62b6f831217f6606dc748f5da0600000000000000010000000100000000000000000000000000000011000000000000001100000000000000485454502f312e3120323030204f4b0d0afc683e433499436826cc6bfec90232ac030000000000000001000000010000000000000013010000000000003e010000000000002b000000000000005374726963742d5472616e73706f72742d53656375726974793a206d61782d6167653d313537363830303046f433584f3bdf162b737889ae611d910000000000000000`;
    const proof = (await new Presentation(proofHex)) as _Presentation;
    const result = await proof.verify();
    console.timeEnd('verify');
    const transcript = new Transcript({
      sent: result.transcript.sent,
      recv: result.transcript.recv,
    });

    const sent = transcript.sent();
    const recv = transcript.recv();
    assert(sent.includes('host: swapi.dev'));
    assert(!sent.includes('secret: test_secret'));
    assert(recv.includes('"name":"Luke Skywalker"'));
    assert(recv.includes('"gender":"male"'));

    // @ts-ignore
    document.getElementById('simple-verify').textContent = 'OK';
  } catch (err) {
    console.log('caught error from wasm');
    console.error(err);

    // @ts-ignore
    document.getElementById('simple-verify').textContent = err.message;
  }
})();
